---
title: "Plotting Diel 1"
author: "Angie Boysen"
date: "September 20, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(  
     message = FALSE,
     warning = FALSE,
     error = FALSE, 
     collapse = TRUE,
     comment = "#",
     fig.align = "center"
)

library(ggplot2)
library(gplots)
library(tidyr)
library(tibble)
require(graphics); require(grDevices)
library(Hmisc)
library(gtools)
library(cowplot)
require(RColorBrewer)
library(xlsx)
library(readr)
library(plotly)
library(stringr)
library(GGally)
library(ggbiplot)
library(stats)
library(dplyr)
```

##read in data
```{r}
dat.join.aq <- read_csv("Cyano_Aq_diel_1_Samples_Normalized_BlkSub_backfill_2IS_noblk.csv")
dat.join.aq <- dat.join.aq[,-1]
# dat.join.aq.less <- read_csv("Cyano_Aq_diel_1_Samples_Normalized_AllWays_noblk.csv")
```


##get sample data for non-IS cmpds
```{r echo=F}
samp.dat <- dat.join.aq %>% filter(type=="Smp") %>%
     filter(Compound.Name!="D-Tryptophan"&
                 Compound.Name!="D-Phenylalanine"&
                 Compound.Name!="d-IAA"&
                 Compound.Name!="d4-Tryptamine"&
                 Compound.Name!="Vitamin B2_IS"&
                 Compound.Name!="Vitamin B7_IS"& 
                 Compound.Name!="Vitamin B1_IS"&
                 Compound.Name!="D8-Arachidonic Acid") %>%
     select(Compound.Name,SampID,
            replicate, PooPlusModel,Notes) %>% 
     gather(Norm,RelArea,-Compound.Name,-SampID,-replicate, -Notes) %>%
     filter(replicate==1 | replicate==2 | replicate==3) %>%
     filter(!is.na(RelArea)) %>%
     mutate(SampID = as.numeric(SampID))
```

##More editing out of cmps that aren't good
```{r edit}
samp.dat <- samp.dat %>%
     filter(Compound.Name != "Indole 3 carboxylic acid" &
                 Compound.Name != "Kinetin" &
                 Compound.Name != "Pyridoxamine" &
                 Compound.Name != "Vitamin B9"  &
                 Compound.Name != "Vitamin C" &
                 Compound.Name != "thiamine pyrophosphate"&
                 Compound.Name != "Vitamin B1" &
                 Compound.Name != "Sulfurol")
```

##TIC
```{r TIC}
TIC <- samp.dat %>%
     group_by(SampID, replicate) %>%
     summarise(TIC = sum(RelArea))
```

##Plot TIC
```{r TICplot}
TIC.means <- TIC %>%
     group_by(SampID) %>%
     summarise(meanTIC = mean(TIC), sd = sd(TIC)) %>%
     mutate(lower = meanTIC - sd, upper = meanTIC + sd)

ggplot(TIC.means, aes(y= meanTIC, x = SampID)) + geom_point() + geom_line() + geom_ribbon(aes(ymin = TIC.means$lower, ymax= TIC.means$upper),alpha=0.1) + geom_vline(xintercept = c(5.5,11.5,17.5,23.5),linetype=2) 
```


##get sample means (not normalized by TIC)
```{r}
samp.dat.means <- samp.dat %>%
     select(-Norm, -Notes) %>%
     group_by(SampID, Compound.Name) %>%
     summarise(meanArea = mean(RelArea), sd = sd(RelArea))
```

##normalize to TIC)
```{r}
samp.TIC <- full_join(samp.dat, TIC) %>%
     mutate(Area.TIC = RelArea/TIC) 

samp.TIC.means <- samp.TIC%>%
     select(-Norm, -Notes, -TIC, -RelArea) %>%
     group_by(SampID, Compound.Name) %>%
     summarise(meanArea = mean(Area.TIC), sd = sd(Area.TIC)) %>%
     mutate(lower = meanArea - sd, upper = meanArea + sd)
```


##Get means and standard deviations, normalized to the max value
```{r echo=FALSE}
test.means <- samp.dat.means %>% select(-sd )%>% spread(Compound.Name, meanArea)

colMax <- function(data) sapply(data, max, na.rm = TRUE)
test.max <- colMax(test.means)

test.means.adjusted <- test.means
for(i in 2:length(test.max)){
     test.means.adjusted[,i] <- test.means[,i]/test.max[i]
}
Adjusted.Means.Long <- test.means.adjusted %>%
     gather(Compound.Name, AdjMean, -SampID)

test.sd <- samp.dat.means %>% select(-meanArea )%>% spread(Compound.Name, sd)
test.sd.adjusted <- test.sd
for(i in 2:length(test.max)){
     test.sd.adjusted[,i] <- test.sd[,i]/test.max[i]
}
Adjusted.SD.Long <- test.sd.adjusted %>%
     gather(Compound.Name, AdjSD, -SampID)

Adjusted.data <- full_join(Adjusted.Means.Long, Adjusted.SD.Long) %>%
     mutate(upper = AdjSD+AdjMean, lower = AdjMean-AdjSD)
```

##Add note/flag back in
```{r notesFunction}
addNotes <- function(summarydata, notsumdata){
     summarydata$Notes <- NA
     for (i in 1:nrow(summarydata)){
          samp <- summarydata$SampID[i]
          cmpd <- summarydata$Compound.Name[i]
          Notes <- notsumdata %>%
               filter(Compound.Name==cmpd, SampID==samp) %>%
               select(Notes) 
          summarydata$Notes[i] <- paste(Notes[[1]],collapse = " ")
     }
     summarydata <- summarydata %>%
          mutate(Flag = ifelse(test = grepl("BackFilled",
                                            Notes),
                               yes = "low",
                               no = ifelse(test = grepl("overloaded",
                                                        Notes),
                                           yes = "over",
                                           no = "ok")))
     
}
```

```{r addNotes}
samp.dat.means <- addNotes(samp.dat.means, samp.dat)
samp.TIC.means <- addNotes(samp.TIC.means, samp.dat)
Adjusted.data <- full_join(Adjusted.data, 
                                samp.dat.means[c("SampID", "Compound.Name",
                                                 "Flag")])
```


#line plots normed to max
```{r echo=FALSE}
p <- ggplot(Adjusted.data, aes(x=SampID, y=AdjMean)) + geom_point(aes(color = Flag)) + scale_color_manual(values = c("grey","black","red")) + geom_line() + facet_wrap(~Compound.Name, scales = "free")
p + geom_ribbon(aes(ymin = Adjusted.data$lower, ymax= Adjusted.data$upper),alpha=0.1) + geom_vline(xintercept = c(5.5,11.5,17.5,23.5),linetype=2) 
```

#line plots no norm to max
```{r echo=FALSE}
samp.dat.means <- samp.dat.means %>%
     mutate(upper = meanArea+sd, lower = meanArea-sd)

q <- ggplot(samp.dat.means, aes(x=SampID, y=meanArea)) + geom_point(aes(color = Flag)) + scale_color_manual(values = c("grey","black","red")) + geom_line() +   facet_wrap(~Compound.Name, scales = "free") 
q   + geom_ribbon(aes(ymin = lower, ymax= upper),alpha=0.1) + geom_vline(xintercept = c(5.5,11.5,17.5,23.5),linetype=2)
```

##line plots normed to TIC
```{r echo=FALSE}
p <- ggplot(samp.TIC.means, aes(x=SampID, y=meanArea)) +  facet_wrap(~Compound.Name, scales = "free")
p +  geom_ribbon(aes(ymin = lower, ymax = upper), alpha=0.1) + geom_point(aes(color = Flag)) + scale_color_manual(values = c("grey","black","red")) + geom_line() + geom_vline(xintercept = c(5.5,11.5,17.5,23.5),linetype=2) 
```

##SAH/SAM
```{r}
sah.sam <- samp.TIC %>%
     filter(Compound.Name == "Adenosyl Homocysteine" |
                 Compound.Name == "Adenosyl Methionine") %>%
     select(SampID, Compound.Name, meanArea) %>%
     spread(Compound.Name,meanArea) %>%
     mutate(sah.sam = `Adenosyl Homocysteine`/`Adenosyl Methionine`)

ggplot(sah.sam, aes(x=SampID, y=sah.sam)) + geom_point() + geom_line() + geom_vline(xintercept = c(5.5,11.5,17.5,23.5),linetype=2) 

```

##PCA
```{r}
pcatest <- samp.TIC %>%
     select(Compound.Name, SampID, replicate, RelArea) %>%
     spread(Compound.Name, RelArea)

dat <- pcatest %>% select(-SampID, -replicate)
     pca <- dat %>% 
          prcomp(center=TRUE, scale.=TRUE)
     # ids <- paste(pcatest$SampID, pcatest$replicate, sep = "_")
     g <- ggbiplot(pca, obs.scale = 1, var.scale = 1, 
                   groups = pcatest$SampID, 
                   labels = pcatest$SampID,
                   var.axes = F
                   # var.axes = T,
                   )
     g <- g + theme(legend.direction = 'horizontal', 
                    legend.position = 'top') + labs(title = "test")
     g
```

##GGscatmat - broken
```{r}
test <- samp.TIC %>%
     select(SampID, replicate, Compound.Name, Area.TIC) %>%
     mutate(key = paste(SampID, replicate, sep="_")) %>%
     select(key, Compound.Name, Area.TIC) %>%
     spread(key, Area.TIC) %>%
     select(-Compound.Name)

ggscatmat(test, columns = 2:6)

ggplot(test, aes(x= `1_1`, xend = `1_2`, y = `2_1`, yend = `2_2`)) +
     geom_segment() + scale_y_log10() + scale_x_log10() +
     theme(aspect.ratio = 1) 
```


##Import cruise log
```{r cruiselog, echo=F}
cruiseLog <- read_csv("Clean Metabolomics Sample Log for SCOPE Cruise_DIEL.csv")
timeData <- cruiseLog %>% select(`Sample ID`, Replicate, Time, 
                                 day.time, Date) %>%
     filter(`Sample ID` <= 24) %>%
     rename(replicate = Replicate, SampID = `Sample ID`) %>%
     select(-replicate) %>% 
     distinct %>%
     mutate(Time = Time/100)
```

##add time data onto Area.TIC
```{r}
samp.TIC.means <- left_join(x = samp.TIC.means, y=timeData)
```

plot
```{r}
g <- ggplot(samp.TIC.means, aes(x=Time, y=meanArea)) +  facet_wrap(~Compound.Name, scales = "free")
g +   geom_point(aes(color = Flag)) + scale_color_manual(values = c("grey","black","red")) + geom_line(aes(linetype=Date)) + geom_vline(xintercept = c(12),linetype=2) 
```

